- name: bare include main.yml
  include_vars: main.yml

- lineinfile:
    destfile: /etc/resolv.conf
    regexp: '8\.8\.8\.8'
    line: 'nameserver 8.8.8.8'
  become: true

- lineinfile:
    destfile: /etc/resolv.conf
    regexp: '8\.8\.4\.4'
    line: 'nameserver 8.8.4.4'
  become: true

- cron:
    name: "check dirs"
    minute: "40"
    hour: "0"
    job: "cd /home/stein/git/webserver && /usr/bin/git pull"

- cron:
    name: "nginx start at reboot"
    special_time: reboot
    job: "/sbin/ninx"
  become: true

- cron:
    name: "auto reload webserver"
    minute: "40"
    hour: "1"
    job: "cd /home/stein/git/webserver && /home/stein/git/perlbrew-cron/perlbrew-cron.sh script/toadfarm.pl reload >>~/log/crontab/toadfarm.log"
  become: true
  become_user: www

- cron:
    name: "start at reboot"
    special_time: reboot
    job: "cd /home/stein/git/webserver && /home/stein/git/perlbrew-cron/perlbrew-cron.sh script/toadfarm.pl reload >>~/log/cro    ntab/toadfarm.log"
  become: true
  become_user: www

- name: upgrade all packages
  yum:
    name: '*'
    state: latest
  become: true

- name: install yum packages
  yum:
    name: epel-release
    state: latest
  become: true

- name: install yum packages2
  yum:
    name: "{{ item }}"
    state: latest
  with_items: "{{ yumpackages }}"
  become: true

- name: install perl modules
  cpanm:
    name: "{{ item }}"
  with_items: '{{ perlmodules }}'
  tags:
    - perl
  become: yes

- name: Test if new config is ok
  command: "/usr/sbin/nginx -t"
  changed_when: False
  become: yes
  become_user: root
  tags:
    - nginx


- name: Work a round nginx bug
  shell: 'ps -ef|grep nginx|grep master|grep -v grep|tr -s " " | cut -d " " -f2 >/run/nginx.pid'
  become: yes
  become_user: root
  tags:
    - nginx

      #prøv service nginx status     på hjernen
      #Må komfe
      #tilnød ps -aux | grep nginx
      # service fungerer rett og slett ikke. Får bruke
- name: Make sure web server is still running. Service module does not work with older nginx.
  #  service: name=nginx state=started enabled=yes
  # command: "service nginx start" #virker ikke
  become: yes
  command: "/usr/sbin/nginx -s reload"
  become_user: root
  tags:
    - nginx

